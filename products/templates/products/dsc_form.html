{% extends 'products/base2.html' %}
{% load static %}

{% block title %}Buy Digital Signature Certificate | FusionTec{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<style>
  :root { --anim-fast: .2s; --anim-med: .45s; --anim-slow: .9s; }
  .toggle-group { gap: .35rem; }
  .toggle-group .btn { transition: all .2s ease-in-out; padding: .45rem .9rem; font-size: .95rem; border-radius: .6rem; }
  .toggle-group .btn.active { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .toggle-group .btn-primary { background: linear-gradient(135deg, #1f3c88 0%, #2563eb 100%); border-color: #1e4db7; }
  .toggle-group .btn-primary:hover { filter: brightness(1.05); }
  .toggle-group .btn-outline-primary { color: #1e4db7; border-color: #1e4db7; }
  .toggle-group .btn-outline-primary:hover { background: rgba(37, 99, 235, .08); color: #1e4db7; border-color: #1e4db7; }
  .price-pulse { animation: pricePulse var(--anim-slow) ease-in-out; }
  @keyframes pricePulse { 0% { transform: scale(1); } 40% { transform: scale(1.02); } 100% { transform: scale(1); } }
  .fade-up { opacity: 0; transform: translateY(12px); animation: fadeUp var(--anim-med) ease-out forwards; }
  @keyframes fadeUp { to { opacity: 1; transform: none; } }
  #enquirySection.ring { box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); border-radius: .5rem; }
  .cta-grid .btn { transition: transform .15s ease-in-out, box-shadow .15s ease-in-out; }
  .cta-grid .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
  .reveal { opacity: 0; transform: translateY(16px); transition: opacity var(--anim-med) ease, transform var(--anim-med) ease; }
  .reveal.is-visible { opacity: 1; transform: none; }
  
  /* Price breakdown cards styling */
  .price-breakdown-card {
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
  }
  
  .price-breakdown-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .price-breakdown-card.total-card {
    border: 2px solid #1f3c88;
    box-shadow: 0 4px 20px rgba(31, 60, 136, 0.15);
  }
  
  /* Decorative soft blobs */
  .soft-blob { position: absolute; border-radius: 999px; filter: blur(25px); opacity: .25; animation: floatBlob 12s ease-in-out infinite; }
  .blob-1 { width: 220px; height: 220px; background: #ffd7ba; top: -40px; right: -40px; }
  .blob-2 { width: 180px; height: 180px; background: #cfe6ff; bottom: -30px; left: -30px; animation-delay: -3s; }
  @keyframes floatBlob { 0%,100% { transform: translateY(0) translateX(0) scale(1); } 50% { transform: translateY(-8px) translateX(6px) scale(1.03); } }
  /* CTA buttons layout */
  .cta-grid { display: grid; grid-template-columns: 1fr; gap: .5rem; }
  /* Visual on right: fill available height */
  .dsc-visual { border: 1px solid #e9ecef; background: #fff; border-radius: .5rem; padding: 1rem; }
  .dsc-visual img { width: 100%; height: 100%; object-fit: contain; }
  @media (max-width: 767.98px){ .dsc-visual { margin-top: .5rem; } }
</style>
<section class="py-5" style="background:#fff7f1;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="position-relative">
          <div class="soft-blob blob-1 d-none d-md-block"></div>
          <div class="soft-blob blob-2 d-none d-md-block"></div>
        </div>
        <div class="card border-0 shadow rounded-4 position-relative overflow-hidden">
          <div class="card-body p-4 p-md-5 fade-up">
            <div class="row g-3 align-items-stretch">
              <div class="col-md-6">
                <h2 class="fw-bold mb-3">Buy Digital Signature Certificate in 3 clicks</h2>
                <ul class="small text-muted mb-4">
                  <li>Government licensed certifying authority partner</li>
                  <li>Used for GST, MCA, Income Tax, Tenders, EPFO and more</li>
                  <li>2048 bit encryption • 24/7 support</li>
                </ul>

                <div class="mb-3">
                  <div class="fw-semibold mb-1">Class Type</div>
                  <div class="btn-group toggle-group" id="classTypeGroup" role="group"></div>
                </div>

                <div class="mb-3">
                  <div class="fw-semibold mb-1">User Type</div>
                  <div class="btn-group toggle-group" id="userTypeGroup" role="group"></div>
                </div>

                <div class="mb-3">
                  <div class="fw-semibold mb-1">Certificate Type</div>
                  <div class="btn-group toggle-group" id="certTypeGroup" role="group"></div>
                </div>

                <div class="mb-3">
                  <div class="fw-semibold mb-1">Validity</div>
                  <div class="btn-group toggle-group" id="validityGroup" role="group"></div>
                </div>



                <div id="addOnsContainer" class="mb-3" style="display:none;">
                  <div class="fw-semibold mb-2">Optional add-ons</div>
                  <div id="tokenRow" class="form-check form-switch mb-2" style="display:none;">
                    <input class="form-check-input" type="checkbox" id="add_token" checked>
                    <label class="form-check-label" for="add_token">Add Token (<span id="tokenAmountLabel">₹0</span>)</label>
                  </div>
                  <div id="installRow" class="form-check form-switch" style="display:none;">
                    <input class="form-check-input" type="checkbox" id="add_installation" checked>
                    <label class="form-check-label" for="add_installation">Add Installation Charges (<span id="installAmountLabel">₹0</span>)</label>
                  </div>
                </div>
              </div>

              <div class="col-md-6 fade-up" style="animation-delay:.1s">
                <div class="dsc-visual h-100 d-flex align-items-center justify-content-center">
                  <img src="{% static 'products/img/e-mudhra.jpg' %}" alt="eMudhra" loading="lazy">
                </div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-12">
                <div class="border rounded-3 p-4 bg-white shadow-sm">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="fw-semibold fs-5">Price Breakdown</div>
                    <a href="{% static 'products/dsc_price_list.pdf' %}" target="_blank" 
                       class="btn btn-outline-primary btn-sm d-flex align-items-center gap-2">
                      <i class="fas fa-file-pdf"></i>
                      <span>View Price List</span>
                    </a>
                  </div>
                  
                  <!-- Price Breakdown Card -->
                  <div class="row g-3 mb-3">
                    <div class="col-md-4">
                      <div class="text-center p-3 rounded-3 price-breakdown-card" style="background: #f8f9fa;">
                        <div class="small text-muted mb-1">Base Amount</div>
                        <div id="baseAmount" class="h5 fw-bold text-primary mb-0">₹ 0</div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="text-center p-3 rounded-3 price-breakdown-card" style="background: #f8f9fa;">
                        <div class="small text-muted mb-1">GST (18%)</div>
                        <div id="gstAmount" class="h5 fw-bold text-warning mb-0">₹ 0</div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="text-center p-3 rounded-3 price-breakdown-card total-card" style="background: linear-gradient(135deg, #1f3c88 0%, #2563eb 100%); color: white;">
                        <div class="small mb-1">Total Amount</div>
                        <div id="priceValue" class="h4 fw-bold mb-0">₹ 0</div>
                      </div>
                    </div>
                  </div>
                  
                  <div id="notConfiguredHint" class="text-danger small d-none">Price not configured for this selection.</div>
                  
                  <!-- Price breakdown info -->
                  <div class="small text-muted mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Price includes DSC charges, token, service charges & GST. 
                    <a href="/dsc/price-list/" class="text-decoration-none">View detailed breakdown</a>
                  </div>
                </div>

                <!-- Enhanced Enquiry Form -->
                <div class="mt-4" id="enquirySection">
                  <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                      <h6 class="fw-semibold mb-0"><i class="fas fa-envelope me-2"></i>Quick Enquiry & Purchase</h6>
                    </div>
                    <div class="card-body p-4">
                      <div class="row g-3">
                        <div class="col-12 col-md-6">
                          <label class="form-label fw-semibold">Full Name *</label>
                          <input type="text" id="enqName" class="form-control form-control-lg" placeholder="Enter your full name">
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label fw-semibold">Email Address *</label>
                          <input type="email" id="enqEmail" class="form-control form-control-lg" placeholder="Enter your email">
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label fw-semibold">Mobile Number *</label>
                          <input type="tel" id="enqMobile" class="form-control form-control-lg" placeholder="Enter mobile number">
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label fw-semibold">Company Name</label>
                          <input type="text" id="enqCompany" class="form-control form-control-lg" placeholder="Company name (optional)">
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label fw-semibold">GST Number</label>
                          <input type="text" id="enqGst" class="form-control form-control-lg" placeholder="GST number (optional)">
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label fw-semibold">Address</label>
                          <input type="text" id="enqAddress" class="form-control form-control-lg" placeholder="Address (optional)">
                        </div>
                        <div class="col-12">
                          <div class="d-grid gap-2">
                            <button id="enqSubmit" class="btn btn-success btn-lg">
                              <i class="fas fa-paper-plane me-2"></i>Send Enquiry
                            </button>
                            <button id="proceedBtn" class="btn btn-primary btn-lg">
                              <i class="fas fa-credit-card me-2"></i>Proceed to Buy
                            </button>
                          </div>
                        </div>
                      </div>
                      <div id="enqMsg" class="alert mt-3" style="display: none;"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {% comment %} <!-- Trust/Stats strip -->
        <div class="row text-center g-3 mt-4 reveal">
          <div class="col-6 col-md-3">
            <div class="p-3 bg-white rounded-3 shadow-sm h-100">
              <div class="h4 mb-0 fw-bold">10K+</div>
              <div class="small text-muted">Certificates delivered</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 bg-white rounded-3 shadow-sm h-100">
              <div class="h4 mb-0 fw-bold">24/7</div>
              <div class="small text-muted">Priority support</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 bg-white rounded-3 shadow-sm h-100">
              <div class="h4 mb-0 fw-bold">3-steps</div>
              <div class="small text-muted">Simple & paperless</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 bg-white rounded-3 shadow-sm h-100">
              <div class="h4 mb-0 fw-bold">Secure</div>
              <div class="small text-muted">2048-bit encryption</div>
            </div>
          </div>
        </div> {% endcomment %}

        <!-- How it works -->
        {% comment %} <div class="mt-5 reveal">
          <h5 class="fw-semibold text-center mb-3">Follow a simple 3-step process</h5>
          <div class="row g-3">
            <div class="col-md-4">
              <div class="h-100 p-3 bg-white rounded-3 shadow-sm">
                <div class="fw-bold mb-1">Step 1</div>
                <div class="text-muted small mb-2">Click on Buy Certificate</div>
                <div class="small">Select the class, user and validity that match your use-case.</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="h-100 p-3 bg-white rounded-3 shadow-sm">
                <div class="fw-bold mb-1">Step 2</div>
                <div class="text-muted small mb-2">Verify your identity online</div>
                <div class="small">Quick and secure paperless eKYC with guided assistance.</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="h-100 p-3 bg-white rounded-3 shadow-sm">
                <div class="fw-bold mb-1">Step 3</div>
                <div class="text-muted small mb-2">Download your DSC</div>
                <div class="small">Instant issuance and installation help from our team.</div>
              </div>
            </div>
          </div>
        </div> {% endcomment %}

        <!-- Security/Compliance -->
        {% comment %} <div class="mt-5 reveal">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="p-3 bg-white rounded-3 shadow-sm h-100">
                <div class="fw-semibold">Compliance</div>
                <div class="small text-muted">CCA guidelines • GST/MCA/IT portals • Tendering</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 bg-white rounded-3 shadow-sm h-100">
                <div class="fw-semibold">Data Security</div>
                <div class="small text-muted">Best practices with hardened infra and access controls</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 bg-white rounded-3 shadow-sm h-100">
                <div class="fw-semibold">Trusted by businesses</div>
                <div class="small text-muted">From MSMEs to enterprises across India</div>
              </div>
            </div>
          </div>
        </div> {% endcomment %}

        <!-- FAQ -->
        {% comment %} <div class="mt-5 reveal">
          <h5 class="fw-semibold mb-3">Frequently asked questions</h5>
          <div class="accordion" id="dscFaq">
            <div class="accordion-item">
              <h2 class="accordion-header" id="q1h">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#q1">What is a Class 3 DSC?</button>
              </h2>
              <div id="q1" class="accordion-collapse collapse" data-bs-parent="#dscFaq">
                <div class="accordion-body small text-muted">A Class 3 DSC is a highly secure certificate used for e-filing on government and tender portals. Available for individuals and organizations with 1–3 year validity.</div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="q2h">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#q2">How long does issuance take?</button>
              </h2>
              <div id="q2" class="accordion-collapse collapse" data-bs-parent="#dscFaq">
                <div class="accordion-body small text-muted">With paperless eKYC and correct documents, issuance can be completed quickly, typically the same day.</div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="q3h">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#q3">Do I need a USB token?</button>
              </h2>
              <div id="q3" class="accordion-collapse collapse" data-bs-parent="#dscFaq">
                <div class="accordion-body small text-muted">Some use-cases require a FIPS-compliant cryptographic token. You can add it as an optional add-on if applicable.</div>
              </div>
            </div>
          </div>
        </div> {% endcomment %}

        {% comment %} <div class="text-muted small mt-4 reveal">
          UI inspired by eMudhra buy page. For official details see
          <a href="https://emudhradigital.com/" target="_blank" rel="noopener">eMudhra</a>.
        </div> {% endcomment %}
      </div>
    </div>
  </div>
</section>

<script>
(function(){
  const proceedBtn = document.getElementById('proceedBtn');
  const enquirySection = document.getElementById('enquirySection');
  const priceEl = document.getElementById('priceValue');
  const notCfg = document.getElementById('notConfiguredHint');
  const addOnsContainer = document.getElementById('addOnsContainer');
  const tokenRow = document.getElementById('tokenRow');
  const installRow = document.getElementById('installRow');
  const tokenCheckbox = document.getElementById('add_token');
  const installCheckbox = document.getElementById('add_installation');
  const tokenAmtLabel = document.getElementById('tokenAmountLabel');
  const installAmtLabel = document.getElementById('installAmountLabel');
  const enqSubmit = document.getElementById('enqSubmit');
  const enqMsg = document.getElementById('enqMsg');
  const enqName = document.getElementById('enqName');
  const enqEmail = document.getElementById('enqEmail');
  const enqMobile = document.getElementById('enqMobile');
  const enqCompany = document.getElementById('enqCompany');
  const enqGst = document.getElementById('enqGst');
  const enqAddress = document.getElementById('enqAddress');

  const state = {
    classType: 'class3',
    userType: 'individual',
    certType: 'signature',
    validity: '2y'
  };

  // Fixed lists for display regardless of DB
  const FIXED_USERS = ['individual', 'organization'];
  const FIXED_CERTS = ['signature', 'encryption', 'both'];
  const FIXED_VALIDS = ['1y', '2y', '3y'];

  // Helper: set active button in a group by value
  function setActive(groupId, value){
    const group = document.getElementById(groupId);
    if(!group) return;
    [...group.querySelectorAll('button')].forEach(btn=>{
      const v = btn.getAttribute('data-value');
      if(v === value){
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-primary','active');
      } else {
        btn.classList.remove('btn-primary','active');
        btn.classList.add('btn-outline-primary');
      }
    });
  }

  // Helper: find first available combination for a class from _dscMap
  function pickFirstAvailableForClass(classKey){
    try{
      const map = window._dscMap || {};
      const byUser = map[classKey] || {};
      // prefer fixed order
      for(const user of FIXED_USERS){
        const byCert = byUser[user];
        if(!byCert) continue;
        for(const cert of FIXED_CERTS){
          const valids = byCert[cert];
          if(Array.isArray(valids) && valids.length){
            // choose first valid in preferred order
            const pref = FIXED_VALIDS.find(v=>valids.includes(v)) || valids[0];
            return { userType: user, certType: cert, validity: pref };
          }
        }
      }
    }catch(e){}
    // fallback: keep current
    return { userType: state.userType, certType: state.certType, validity: state.validity };
  }

  // Helper: check if a combination has a price configured
  function hasPriceForCombination(classType, userType, certType, validity) {
    try {
      const map = window._dscMap || {};
      const byUser = map[classType] || {};
      const byCert = byUser[userType] || {};
      const valids = byCert[certType] || [];
      return valids.includes(validity);
    } catch(e) {
      return false;
    }
  }

  // Fallback local price table if backend is not ready
  const localPrices = {
    class3: {
      signature: { '1y': 2890, '2y': 3067, '3y': 3952 },
      encryption: { '1y': 2890, '2y': 3067, '3y': 3952 }, // same as signature for now
      both: { '1y': 3657, '2y': 3952, '3y': 5250 },
      foreign: {
        signature: { '2y': 14868 },
        both: { '2y': 20768 }
      }
    },
    dgft: {
      signature: { '1y': 3421, '2y': 3657 },
      encryption: { '1y': 3421, '2y': 3657 },
      both: { '1y': 3421, '2y': 3657 }
    }
  };

  let lastComponents = null;
  let lastGST = 0;
  let lastSurcharge = 0;
  let currentDisplayedPrice = 0;

  function setPriceValue(value, baseAmount = null, gstAmount = null){
    const target = Number(value) || 0;
    const start = Number(String(priceEl.textContent).replace(/[^0-9.]/g,'')) || currentDisplayedPrice || 0;
    const duration = 450;
    const startTime = performance.now();
    
    // Update base amount and GST amount if provided
    if (baseAmount !== null) {
      const baseEl = document.getElementById('baseAmount');
      if (baseEl) {
        baseEl.textContent = `₹ ${Number(baseAmount).toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
      }
    }
    
    if (gstAmount !== null) {
      const gstEl = document.getElementById('gstAmount');
      if (gstEl) {
        gstEl.textContent = `₹ ${Number(gstAmount).toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
      }
    }
    
    priceEl.classList.add('price-pulse');
    function step(now){
      const t = Math.min(1, (now - startTime) / duration);
      const eased = t * (2 - t);
      const val = start + (target - start) * eased;
      priceEl.textContent = `₹ ${Number(val).toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
      if(t < 1){
        requestAnimationFrame(step);
      } else {
        currentDisplayedPrice = target;
        setTimeout(()=>priceEl.classList.remove('price-pulse'), 150);
      }
    }
    requestAnimationFrame(step);
  }

  function renderComputedPrice(){
    if(!lastComponents){
      return;
    }
    const dsc = parseFloat(lastComponents.dsc_charge || 0);
    const token = parseFloat(lastComponents.token_amount || 0);
    const install = parseFloat(lastComponents.installation_charge || 0);
    const gstPct = parseFloat(lastGST || 0);
    const includeToken = token > 0 && (tokenCheckbox ? tokenCheckbox.checked : true);
    const includeInstall = install > 0 && (installCheckbox ? installCheckbox.checked : true);
    const base = dsc + (includeToken ? token : 0) + (includeInstall ? install : 0);
    let total = base * (1 + (gstPct/100));
    const gstAmount = total - base;
    setPriceValue(total, base, gstAmount);
  }

  async function updatePrice(){
    try{
      const params = new URLSearchParams({
        class_type: state.classType,
        user_type: state.userType,
        cert_type: state.certType,
        validity: state.validity,
        outside: '0'
      });
      const resp = await fetch(`/api/dsc-price/?${params.toString()}`);
      const data = await resp.json();
      if(data.success){
        if(notCfg) notCfg.classList.add('d-none');
        const comps = data.components || {};
        lastComponents = comps;
        lastGST = comps.gst_percent || 0;
        lastSurcharge = data.outside_surcharge || 0;

        // Show/hide add-on toggles
        const tokenVal = parseFloat(comps.token_amount || 0);
        const installVal = parseFloat(comps.installation_charge || 0);
        if(tokenVal > 0 || installVal > 0){
          addOnsContainer.style.display = '';
        } else {
          addOnsContainer.style.display = 'none';
        }
        if(tokenVal > 0){
          tokenRow.style.display = '';
          tokenAmtLabel.textContent = `₹${Number(tokenVal).toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
          if(tokenCheckbox) tokenCheckbox.checked = true;
        } else {
          tokenRow.style.display = 'none';
          if(tokenCheckbox) tokenCheckbox.checked = false;
        }
        if(installVal > 0){
          installRow.style.display = '';
          installAmtLabel.textContent = `₹${Number(installVal).toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
          if(installCheckbox) installCheckbox.checked = true;
        } else {
          installRow.style.display = 'none';
          if(installCheckbox) installCheckbox.checked = false;
        }

        renderComputedPrice();
      } else {
        throw new Error('Price not configured for this combination');
      }
    } catch(e){
      // Fallback: use local table or show price not configured
      try {
        if(notCfg) notCfg.classList.remove('d-none');
        // Hide add-ons when DB/pricing not configured for this selection
        lastComponents = null;
        if(addOnsContainer) addOnsContainer.style.display = 'none';
        if(tokenRow) tokenRow.style.display = 'none';
        if(installRow) installRow.style.display = 'none';
        if(tokenCheckbox) tokenCheckbox.checked = false;
        if(installCheckbox) installCheckbox.checked = false;

        const outside = outsideIndia && outsideIndia.checked;
        let price = null;
        if (outside && state.classType === 'class3' && state.validity === '2y') {
          price = (localPrices.class3.foreign[state.certType]||{})['2y'] || null;
        }
        if (price == null) {
          const table = (localPrices[state.classType]||{})[state.certType]||{};
          price = table[state.validity] || null;
        }
        if(price != null){
          priceEl.classList.remove('text-muted');
          // Calculate breakdown for fallback prices (assuming 18% GST)
          const baseAmount = price / 1.18; // Remove GST to get base amount
          const gstAmount = price - baseAmount;
          setPriceValue(price, baseAmount, gstAmount);
        } else {
          priceEl.textContent = 'Price not configured for this combination';
          priceEl.classList.add('text-muted');
        }
      } catch (err) {
        priceEl.textContent = 'Price not configured for this combination';
        priceEl.classList.add('text-muted');
      }
    }
  }

  function wireGroup(groupId, key){
    const group = document.getElementById(groupId);
    if(!group) return;
    group.addEventListener('click', function(e){
      const btn = e.target.closest('button');
      if(!btn) return;
      [...group.querySelectorAll('button')].forEach(b=>{
        b.classList.remove('btn-primary','active');
        b.classList.add('btn-outline-primary');
      });
      btn.classList.remove('btn-outline-primary');
      btn.classList.add('btn-primary','active');
      const val = btn.getAttribute('data-value');
      if(val) state[key] = val;

      if(key === 'classType'){
        // Auto-pick first priced combo for this class
        const picked = pickFirstAvailableForClass(state.classType);
        state.userType = picked.userType;
        state.certType = picked.certType;
        state.validity = picked.validity;
        // Reflect in UI groups
        setActive('userTypeGroup', state.userType);
        setActive('certTypeGroup', state.certType);
        setActive('validityGroup', state.validity);
      }
      
      // Update price and show/hide price warning
      updatePrice();
      
      // Update button styles based on price availability
      updateButtonStyles();
    });
  }

  wireGroup('classTypeGroup','classType');
  wireGroup('userTypeGroup','userType');
  wireGroup('certTypeGroup','certType');
  wireGroup('validityGroup','validity');



  if(tokenCheckbox){
    tokenCheckbox.addEventListener('change', renderComputedPrice);
  }
  if(installCheckbox){
    installCheckbox.addEventListener('change', renderComputedPrice);
  }

  if(enqSubmit){
    enqSubmit.addEventListener('click', async function(){
      enqMsg.style.display = 'block';
      enqMsg.textContent = '';
      enqMsg.className = 'alert mt-3';
      
      const name = (enqName?.value || '').trim();
      const email = (enqEmail?.value || '').trim();
      const mobileNo = (enqMobile?.value || '').trim();
      const company = (enqCompany?.value || '').trim();
      const gst = (enqGst?.value || '').trim();
      const address = (enqAddress?.value || '').trim();
      
      if(!name || !email || !mobileNo){
        enqMsg.textContent = 'Please fill Name, Email and Mobile.';
        enqMsg.className = 'alert alert-danger mt-3';
        return;
      }
      
      // Compute current quoted price number from UI text (safe fallback)
      const totalStr = priceEl.textContent.replace(/[^0-9.]/g,'');
      const quoted = parseFloat(totalStr || '0') || 0;
      
      const payload = {
        name,
        email,
        mobile: mobileNo,
        company_name: company,
        gst_number: gst,
        address,
        class_type: state.classType,
        user_type: state.userType,
        cert_type: state.certType,
        validity: state.validity,
        include_token: !!(tokenCheckbox && tokenCheckbox.checked),
        include_installation: !!(installCheckbox && installCheckbox.checked),
        outside_india: false,
        quoted_price: quoted
      };
      
      try{
        const resp = await fetch('/api/dsc-enquiry/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if(data.success){
          enqMsg.textContent = 'Enquiry submitted successfully. We will contact you soon.';
          enqMsg.className = 'alert alert-success mt-3';
          enqName.value = '';
          enqEmail.value = '';
          enqMobile.value = '';
          enqCompany.value = '';
          enqGst.value = '';
          enqAddress.value = '';
        } else {
          throw new Error(data.message || 'Failed to submit');
        }
      } catch(err){
        enqMsg.textContent = 'Failed to submit enquiry. Please try again.';
        enqMsg.className = 'alert alert-danger mt-3';
      }
    });
  }
  // Initialize price breakdown display
  function initializePriceDisplay() {
    // Set initial values
    const baseEl = document.getElementById('baseAmount');
    const gstEl = document.getElementById('gstAmount');
    const priceEl = document.getElementById('priceValue');
    
    if (baseEl) baseEl.textContent = '₹ 0';
    if (gstEl) gstEl.textContent = '₹ 0';
    if (priceEl) priceEl.textContent = '₹ 0';
  }

  // Build buttons dynamically; fall back to fixed options if API fails or returns empty
  async function buildOptions(){
    let classes = [];
    let map = {};
    let defaults = {};
    try{
      const resp = await fetch('/api/dsc-options/');
      const data = await resp.json();
      if(data && data.success){
        classes = Array.isArray(data.classes) ? data.classes : [];
        map = data.map || {};
        defaults = data.defaults || {};
      }
    }catch(e){
      // ignore; will fall back below
    }

    // Fallbacks when API missing/empty
    if(!classes || classes.length === 0){
      classes = ['class3','dgft'];
    }
    window._dscMap = map || {};

    // Normalize helper
    function norm(s){ return (s||'').toString().trim(); }

    // Seed state from defaults or sensible defaults
    state.classType = norm(defaults.class_type) || classes[0] || 'class3';
    // Default to fixed lists; auto-pick first in fixed list
    state.userType = FIXED_USERS.includes(norm(defaults.user_type)) ? norm(defaults.user_type) : FIXED_USERS[0];
    state.certType = FIXED_CERTS.includes(norm(defaults.cert_type)) ? norm(defaults.cert_type) : FIXED_CERTS[0];
    state.validity = FIXED_VALIDS.includes(norm(defaults.validity)) ? norm(defaults.validity) : FIXED_VALIDS[1];

    // Render groups
    renderGroup('classTypeGroup', classes, state.classType, v=>{
      if(v==='class3') return 'Class 3';
      if(v==='dgft') return 'DGFT';
      return v.charAt(0).toUpperCase()+v.slice(1);
    });
    renderGroup('userTypeGroup', FIXED_USERS, state.userType, v=> v==='individual'?'Individual':'Organization');
    renderGroup('certTypeGroup', FIXED_CERTS, state.certType, v=> v.charAt(0).toUpperCase()+v.slice(1));
    renderGroup('validityGroup', FIXED_VALIDS, state.validity, v=> ({'1y':'1 Year','2y':'2 Years','3y':'3 Years'}[v]||v));

    // Initial price and button styles
    updatePrice();
    updateButtonStyles();
  }

  // Helper function to render button groups
  function renderGroup(groupId, values, activeValue, formatter) {
    const group = document.getElementById(groupId);
    if (!group) return;
    
    group.innerHTML = '';
    values.forEach(value => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-outline-primary position-relative';
      btn.setAttribute('data-value', value);
      btn.textContent = formatter ? formatter(value) : value;
      if (value === activeValue) {
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-primary', 'active');
      }
      group.appendChild(btn);
    });
  }

  // Function to update button styles based on price availability
  function updateButtonStyles() {
    // Update user type buttons
    const userGroup = document.getElementById('userTypeGroup');
    if (userGroup) {
      [...userGroup.querySelectorAll('button')].forEach(btn => {
        const userType = btn.getAttribute('data-value');
        const hasPrice = hasPriceForCombination(state.classType, userType, state.certType, state.validity);
        if (hasPrice) {
          btn.classList.remove('text-muted');
          btn.style.opacity = '1';
          btn.title = '';
          // Add price indicator
          if (!btn.querySelector('.price-indicator')) {
            const indicator = document.createElement('span');
            indicator.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success price-indicator';
            indicator.style.fontSize = '0.5rem';
            indicator.style.transform = 'translate(-50%, -50%)';
            indicator.textContent = '₹';
            indicator.title = 'Price available';
            btn.appendChild(indicator);
          }
        } else {
          btn.classList.add('text-muted');
          btn.style.opacity = '0.6';
          btn.title = 'Price not configured for this combination';
          // Remove price indicator
          const indicator = btn.querySelector('.price-indicator');
          if (indicator) indicator.remove();
        }
      });
    }

    // Update certificate type buttons
    const certGroup = document.getElementById('certTypeGroup');
    if (certGroup) {
      [...certGroup.querySelectorAll('button')].forEach(btn => {
        const certType = btn.getAttribute('data-value');
        const hasPrice = hasPriceForCombination(state.classType, state.userType, certType, state.validity);
        if (hasPrice) {
          btn.classList.remove('text-muted');
          btn.style.opacity = '1';
          btn.title = '';
          // Add price indicator
          if (!btn.querySelector('.price-indicator')) {
            const indicator = document.createElement('span');
            indicator.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success price-indicator';
            indicator.style.fontSize = '0.5rem';
            indicator.style.transform = 'translate(-50%, -50%)';
            indicator.textContent = '₹';
            indicator.title = 'Price available';
            btn.appendChild(indicator);
          }
        } else {
          btn.classList.add('text-muted');
          btn.style.opacity = '0.6';
          btn.title = 'Price not configured for this combination';
          // Remove price indicator
          const indicator = btn.querySelector('.price-indicator');
          if (indicator) indicator.remove();
        }
      });
    }

    // Update validity buttons
    const validityGroup = document.getElementById('validityGroup');
    if (validityGroup) {
      [...validityGroup.querySelectorAll('button')].forEach(btn => {
        const validity = btn.getAttribute('data-value');
        const hasPrice = hasPriceForCombination(state.classType, state.userType, state.certType, validity);
        if (hasPrice) {
          btn.classList.remove('text-muted');
          btn.style.opacity = '1';
          btn.title = '';
          // Add price indicator
          if (!btn.querySelector('.price-indicator')) {
            const indicator = document.createElement('span');
            indicator.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success price-indicator';
            indicator.style.fontSize = '0.5rem';
            indicator.style.transform = 'translate(-50%, -50%)';
            indicator.textContent = '₹';
            indicator.title = 'Price available';
            btn.appendChild(indicator);
          }
        } else {
          btn.classList.add('text-muted');
          btn.style.opacity = '0.6';
          btn.title = 'Price not configured for this combination';
          // Remove price indicator
          const indicator = btn.querySelector('.price-indicator');
          if (indicator) indicator.remove();
        }
      });
    }
  }

  buildOptions();

  // Initialize price display
  initializePriceDisplay();

  // Payment functionality for "Proceed to Buy" button
  if(proceedBtn){
    proceedBtn.addEventListener('click', async function(){
      enqMsg.style.display = 'block';
      enqMsg.textContent = '';
      enqMsg.className = 'alert mt-3';
      
      const name = (enqName?.value || '').trim();
      const email = (enqEmail?.value || '').trim();
      const mobileNo = (enqMobile?.value || '').trim();
      const company = (enqCompany?.value || '').trim();
      const gst = (enqGst?.value || '').trim();
      const address = (enqAddress?.value || '').trim();
      
      if(!name || !email || !mobileNo){
        enqMsg.textContent = 'Please fill Name, Email and Mobile to proceed with payment.';
        enqMsg.className = 'alert alert-danger mt-3';
        return;
      }
      
      // Compute current quoted price
      const totalStr = priceEl.textContent.replace(/[^0-9.]/g,'');
      const quoted = parseFloat(totalStr || '0') || 0;
      
      if(quoted <= 0){
        enqMsg.textContent = 'Please select valid DSC options to proceed with payment.';
        enqMsg.className = 'alert alert-warning mt-3';
        return;
      }
      
      try{
        // First create submission
        const submissionPayload = {
          name,
          email,
          mobile: mobileNo,
          company_name: company,
          gst_number: gst,
          address,
          class_type: state.classType,
          user_type: state.userType,
          cert_type: state.certType,
          validity: state.validity,
          include_token: !!(tokenCheckbox && tokenCheckbox.checked),
          include_installation: !!(installCheckbox && installCheckbox.checked),
          outside_india: false,
          quoted_price: quoted
        };
        
        const submissionResp = await fetch('/api/dsc-submission/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(submissionPayload)
        });
        
        const submissionData = await submissionResp.json();
        if(!submissionData.success){
          throw new Error(submissionData.message || 'Failed to create submission');
        }
        
        // Create payment order
        const orderPayload = {
          submission_id: submissionData.submission_id,
          amount: quoted
        };
        
        const orderResp = await fetch('/api/dsc-payment/create-order/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderPayload)
        });
        
        const orderData = await orderResp.json();
        if(orderData.status !== 'success'){
          throw new Error(orderData.message || 'Failed to create payment order');
        }
        
        // Initialize Razorpay payment
        const options = {
          key: orderData.key,
          amount: orderData.amount,
          currency: orderData.currency,
          name: 'FusionTec Solutions',
          description: `DSC ${state.classType.toUpperCase()} - ${state.userType} - ${state.certType} - ${state.validity}`,
          order_id: orderData.order_id,
          handler: async function (response) {
            try{
              // Verify payment
              const verifyPayload = {
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                submission_id: submissionData.submission_id
              };
              
              const verifyResp = await fetch('/api/dsc-payment/verify/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(verifyPayload)
              });
              
              const verifyData = await verifyResp.json();
              if(verifyData.status === 'success'){
                enqMsg.textContent = 'Payment successful! Your DSC order has been placed. We will contact you soon.';
                enqMsg.className = 'alert alert-success mt-3';
                // Clear form
                enqName.value = '';
                enqEmail.value = '';
                enqMobile.value = '';
                enqCompany.value = '';
                enqGst.value = '';
                enqAddress.value = '';
              } else {
                throw new Error(verifyData.message || 'Payment verification failed');
              }
            } catch(err){
              enqMsg.textContent = `Payment verification failed: ${err.message}`;
              enqMsg.className = 'alert alert-danger mt-3';
            }
          },
          prefill: {
            name: name,
            email: email,
            contact: mobileNo
          },
          theme: {
            color: '#2563eb'
          }
        };
        
        const rzp = new Razorpay(options);
        rzp.open();
        
      } catch(err){
        enqMsg.textContent = `Payment initialization failed: ${err.message}`;
        enqMsg.className = 'alert alert-danger mt-3';
      }
    });
  }

  function scrollToEnquiry(){
    if(!enquirySection) return;
    enquirySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    enquirySection.classList.add('ring');
    setTimeout(()=> enquirySection.classList.remove('ring'), 1500);
  }

  // Reveal on scroll
  const revealEls = document.querySelectorAll('.reveal');
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        e.target.classList.add('is-visible');
        io.unobserve(e.target);
      }
    });
  }, { rootMargin: '0px 0px -10% 0px', threshold: 0.1 });
  revealEls.forEach(el=> io.observe(el));
})();
</script>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  let lastGST = 0;

  let lastSurcharge = 0;

  let currentDisplayedPrice = 0;



  function setPriceValue(value){

    const target = Number(value) || 0;

    const start = Number(String(priceEl.textContent).replace(/[^0-9.]/g,'')) || currentDisplayedPrice || 0;

    const duration = 450;

    const startTime = performance.now();

    priceEl.classList.add('price-pulse');

    function step(now){

      const t = Math.min(1, (now - startTime) / duration);

      const eased = t * (2 - t);

      const val = start + (target - start) * eased;

      priceEl.textContent = `₹ ${Number(val).toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;

      if(t < 1){

        requestAnimationFrame(step);

      } else {

        currentDisplayedPrice = target;

        setTimeout(()=>priceEl.classList.remove('price-pulse'), 150);

      }

    }

    requestAnimationFrame(step);

  }



  function renderComputedPrice(){

    if(!lastComponents){

      return;

    }

    const dsc = parseFloat(lastComponents.dsc_charge || 0);

    const token = parseFloat(lastComponents.token_amount || 0);

    const install = parseFloat(lastComponents.installation_charge || 0);

    const gstPct = parseFloat(lastGST || 0);

    const includeToken = token > 0 && (tokenCheckbox ? tokenCheckbox.checked : true);

    const includeInstall = install > 0 && (installCheckbox ? installCheckbox.checked : true);

    const base = dsc + (includeToken ? token : 0) + (includeInstall ? install : 0);

    let total = base * (1 + (gstPct/100));

    if(outsideIndia && outsideIndia.checked){

      total += parseFloat(lastSurcharge || 0);

    }

    setPriceValue(total);

  }



  async function updatePrice(){

    try{

      const params = new URLSearchParams({

        class_type: state.classType,

        user_type: state.userType,

        cert_type: state.certType,

        validity: state.validity,

        outside: outsideIndia && outsideIndia.checked ? '1' : '0'

      });

      const resp = await fetch(`/api/dsc-price/?${params.toString()}`);

      const data = await resp.json();

      if(data.success){

        if(notCfg) notCfg.classList.add('d-none');

        const comps = data.components || {};

        lastComponents = comps;

        lastGST = comps.gst_percent || 0;

        lastSurcharge = data.outside_surcharge || 0;



        // Show/hide add-on toggles

        const tokenVal = parseFloat(comps.token_amount || 0);

        const installVal = parseFloat(comps.installation_charge || 0);

        if(tokenVal > 0 || installVal > 0){

          addOnsContainer.style.display = '';

        } else {

          addOnsContainer.style.display = 'none';

        }

        if(tokenVal > 0){

          tokenRow.style.display = '';

          tokenAmtLabel.textContent = `₹${Number(tokenVal).toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;

          if(tokenCheckbox) tokenCheckbox.checked = true;

        } else {

          tokenRow.style.display = 'none';

          if(tokenCheckbox) tokenCheckbox.checked = false;

        }

        if(installVal > 0){

          installRow.style.display = '';

          installAmtLabel.textContent = `₹${Number(installVal).toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;

          if(installCheckbox) installCheckbox.checked = true;

        } else {

          installRow.style.display = 'none';

          if(installCheckbox) installCheckbox.checked = false;

        }



        renderComputedPrice();

      } else {

        throw new Error('Backend not configured');

      }

    } catch(e){

      // Fallback: use local table

      try {

        if(notCfg) notCfg.classList.remove('d-none');

        // Hide add-ons when DB/pricing not configured for this selection

        lastComponents = null;

        if(addOnsContainer) addOnsContainer.style.display = 'none';

        if(tokenRow) tokenRow.style.display = 'none';

        if(installRow) installRow.style.display = 'none';

        if(tokenCheckbox) tokenCheckbox.checked = false;

        if(installCheckbox) installCheckbox.checked = false;



        const outside = outsideIndia && outsideIndia.checked;

        let price = null;

        if (outside && state.classType === 'class3' && state.validity === '2y') {

          price = (localPrices.class3.foreign[state.certType]||{})['2y'] || null;

        }

        if (price == null) {

          const table = (localPrices[state.classType]||{})[state.certType]||{};

          price = table[state.validity] || null;

        }

        if(price != null){

          setPriceValue(price);

        } else {

          priceEl.textContent = 'Price not configured';

        }

      } catch (err) {

        priceEl.textContent = 'Price unavailable';

      }

    }

  }



  function wireGroup(groupId, key){

    const group = document.getElementById(groupId);

    if(!group) return;

    group.addEventListener('click', function(e){

      const btn = e.target.closest('button');

      if(!btn) return;

      [...group.querySelectorAll('button')].forEach(b=>{

        b.classList.remove('btn-primary','active');

        b.classList.add('btn-outline-primary');

      });

      btn.classList.remove('btn-outline-primary');

      btn.classList.add('btn-primary','active');

      const val = btn.getAttribute('data-value');

      if(val) state[key] = val;

      updatePrice();

    });

  }



  wireGroup('classTypeGroup','classType');

  wireGroup('userTypeGroup','userType');

  wireGroup('certTypeGroup','certType');

  wireGroup('validityGroup','validity');



  if(outsideIndia){

    outsideIndia.addEventListener('change', function(){

      // Recompute locally using surcharge if we already have components

      if(lastComponents){

        renderComputedPrice();

      } else {

        updatePrice();

      }

    });

  }



  if(tokenCheckbox){

    tokenCheckbox.addEventListener('change', renderComputedPrice);

  }

  if(installCheckbox){

    installCheckbox.addEventListener('change', renderComputedPrice);

  }



  if(enqSubmit){

    enqSubmit.addEventListener('click', async function(){

      enqMsg.textContent = '';

      const name = (enqName?.value || '').trim();

      const email = (enqEmail?.value || '').trim();

      const mobileNo = (enqMobile?.value || '').trim();

      const address = (enqAddress?.value || '').trim();

      if(!name || !email || !mobileNo){

        enqMsg.textContent = 'Please fill Name, Email and Mobile.';

        enqMsg.className = 'small mt-2 text-danger';

        return;

      }

      // Compute current quoted price number from UI text (safe fallback)

      const totalStr = priceEl.textContent.replace(/[^0-9.]/g,'');

      const quoted = parseFloat(totalStr || '0') || 0;

      const payload = {

        name,

        email,

        mobile: mobileNo,

        address,

        class_type: state.classType,

        user_type: state.userType,

        cert_type: state.certType,

        validity: state.validity,

        include_token: !!(tokenCheckbox && tokenCheckbox.checked),

        include_installation: !!(installCheckbox && installCheckbox.checked),

        outside_india: false,

        quoted_price: quoted

      };

      try{

        const resp = await fetch('/api/dsc-enquiry/', {

          method: 'POST',

          headers: { 'Content-Type': 'application/json' },

          body: JSON.stringify(payload)

        });

        const data = await resp.json();

        if(data.success){

          enqMsg.textContent = 'Enquiry submitted successfully. We will contact you soon.';

          enqMsg.className = 'small mt-2 text-success';

          enqName.value = '';

          enqEmail.value = '';

          enqMobile.value = '';

          enqAddress.value = '';

        } else {

          throw new Error(data.message || 'Failed to submit');

        }

      } catch(err){

        enqMsg.textContent = 'Failed to submit enquiry. Please try again.';

        enqMsg.className = 'small mt-2 text-danger';

      }

    });

  }

  // Build buttons dynamically from backend options

  async function buildOptions(){

    try{

      const resp = await fetch('/api/dsc-options/');

      const data = await resp.json();

      if(!data.success) return;

      const classes = data.classes || [];

      const map = data.map || {};

      const defaults = data.defaults || {};

      const classEl = document.getElementById('classTypeGroup');

      const userEl = document.getElementById('userTypeGroup');

      const certEl = document.getElementById('certTypeGroup');

      const valEl = document.getElementById('validityGroup');



      function renderButtons(el, values, activeVal, format){

        el.innerHTML='';

        (values||[]).forEach(v=>{

          const btn = document.createElement('button');

          btn.type='button';

          btn.className = 'btn ' + (v===activeVal ? 'btn-primary active' : 'btn-outline-primary');

          btn.setAttribute('data-value', v);

          btn.textContent = format ? format(v) : v;

          el.appendChild(btn);

        });

      }



      // pick defaults

      state.classType = defaults.class_type || classes[0] || 'class3';

      const users = Object.keys(map[state.classType]||{individual:{}});

      state.userType = defaults.user_type || users[0] || 'individual';

      const certs = Object.keys((map[state.classType]||{})[state.userType]||{signature:[]});

      state.certType = defaults.cert_type || certs[0] || 'signature';

      const valids = ((map[state.classType]||{})[state.userType]||{})[state.certType] || [];

      // If no validities available, keep state but render none; price will show 'not configured'

      state.validity = defaults.validity || valids[0] || '1y';



      renderButtons(classEl, classes, state.classType, v=>{

        if(v==='class3') return 'Class 3';

        if(v==='dgft') return 'DGFT';

        return v.charAt(0).toUpperCase()+v.slice(1);

      });

      renderButtons(userEl, users, state.userType, v=> v==='individual'?'Individual':'Organization');

      renderButtons(certEl, certs, state.certType, v=> v.charAt(0).toUpperCase()+v.slice(1));

      renderButtons(valEl, valids, state.validity, v=> ({'1y':'1 Year','2y':'2 Years','3y':'3 Years'}[v]||v));

      if(valids && valids.length){

        valEl.classList.remove('opacity-50');

        valEl.style.pointerEvents = '';

      } else {

        valEl.classList.add('opacity-50');

        valEl.style.pointerEvents = 'none';

      }



      updatePrice();

    } catch(e){

      // If options API fails, keep existing UI but attempt price fetch

      updatePrice();

    }

  }



  buildOptions();



  function scrollToEnquiry(){

    if(!enquirySection) return;

    enquirySection.scrollIntoView({ behavior: 'smooth', block: 'start' });

    enquirySection.classList.add('ring');

    setTimeout(()=> enquirySection.classList.remove('ring'), 1500);

  }

  if(proceedBtn){ proceedBtn.addEventListener('click', scrollToEnquiry); }

  if(talkBtn){ talkBtn.addEventListener('click', scrollToEnquiry); }



  // Reveal on scroll

  const revealEls = document.querySelectorAll('.reveal');

  const io = new IntersectionObserver((entries)=>{

    entries.forEach(e=>{

      if(e.isIntersecting){

        e.target.classList.add('is-visible');

        io.unobserve(e.target);

      }

    });

  }, { rootMargin: '0px 0px -10% 0px', threshold: 0.1 });

  revealEls.forEach(el=> io.observe(el));

})();

</script>
{% endblock %}