{% extends 'products/base2.html' %}
{% load static %}
{% block title %}Fusiontec - {% if available_products.count == 1 and products_with_rates %}{{ products_with_rates.0.product.prdt_desc }}{% else %}Product{% endif %} Form{% endblock %}

{% block content %}
<style>
  body {
    background-color: #f8f9fa;
  }
  .form-container {
    background: #fff;
    border-radius: 0.75rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    padding: 2rem;
    max-width: 600px;
    margin: 2rem auto;
  }
  .form-section {
    margin-bottom: 1.5rem;
  }
  .form-section h6 {
    margin-bottom: 0.75rem;
  }
  /* PI Table Styling */
  #piContent table {
    width: 100%;
    border-collapse: collapse;
  }
  #piContent th, #piContent td {
    border: 1px solid #dee2e6;
    padding: 0.5rem 1rem;
    text-align: left;
  }
  #piContent th {
    background-color: #e9ecef;
    width: 35%;
  }
   .error-message {
    color: red;
    font-size: 0.875rem;
    margin-top: 4px;
  }
     .product-info {
     background: #f8f9fa;
     border-radius: 0.5rem;
     padding: 1rem;
     margin-bottom: 1.5rem;
     border-left: 4px solid #0d6efd;
   }
   .rate-card-card {
     border: 1px solid #dee2e6;
     border-radius: 0.5rem;
     transition: all 0.3s ease;
   }
   .rate-card-card:hover {
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
     transform: translateY(-2px);
   }
  /* Proforma Invoice modal styling */
  .pi-header {
    background: linear-gradient(90deg, #0d6efd, #6610f2);
    color: #fff;
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 16px;
  }
  .pi-header .pi-title { font-weight: 700; font-size: 16px; }
  .pi-header .pi-sub { opacity: 0.9; font-size: 12px; }
  .pi-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
  .pi-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px 12px; }
  .pi-card .label { color: #6c757d; font-size: 12px; }
  .pi-card .value { font-weight: 700; font-size: 16px; }
  .pi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .pi-table { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden; }
  .pi-table th, .pi-table td { padding: 8px 10px; border-bottom: 1px solid #e9ecef; font-size: 13px; }
  .pi-table th { background: #f1f3f5; text-align: left; color: #495057; width: 40%; }
  .pi-table tr:last-child td, .pi-table tr:last-child th { border-bottom: none; }
  .pi-total-row th, .pi-total-row td { background: #fff3cd; font-weight: 700; }
</style>

<div class="container">
  <div class="form-container">
    <h4 class="text-primary text-center">
      <span id="formHeading">
        {% if available_products.count == 1 and products_with_rates %}
          {{ products_with_rates.0.product.prdt_desc }}
        {% else %}
          Product
        {% endif %}
        Form
      </span>
    </h4>
    
    <!-- Product Information Display removed as requested -->

    <form id="productForm" method="post">
      {% csrf_token %}

      <!-- Customer Info -->
      <div class="form-section">
        <label for="customerName" class="form-label">Customer Name <span style="color:red">*</span></label>
        <input type="text" id="customerName" name="customer_name" class="form-control" maxlength="50" required />
        <div class="error-message" id="error-customerName"></div>
      </div>

      <div class="form-section">
        <label for="companyName" class="form-label">Company Name</label>
        <input type="text" id="companyName" name="company_name" class="form-control" maxlength="50"/>
        <div class="error-message" id="error-companyName"></div>
      </div>

      <!-- GST Selection -->
      <div class="form-section">
        <label for="gstSelector" class="form-label">GST Number?</label>
        <select id="gstSelector" name="has_gst" class="form-select">
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
        <div class="error-message" id="error-gstSelector"></div>
      </div>

      <div class="form-section" id="gstNumberField">
        <label for="gstNumber" class="form-label">GST Number <span style="color:red">*</span></label>
        <input type="text" id="gstNumber" name="gst_number" class="form-control" maxlength="15"/>
        <div class="error-message" id="error-gstNumber"></div>
      </div>

      <div class="form-section" id="nonGstFields" style="display: none;">
        <label for="address" class="form-label">Address <span style="color:red">*</span></label>
        <textarea id="address" name="address" class="form-control"></textarea>
        <div class="error-message" id="error-address"></div>

        <div class="row g-2 mt-2">
          <div class="col-12 col-md-4">
            <select id="state" name="state" class="form-select">
              <option value="">Select State</option>
            </select>
            <div class="error-message" id="error-state"></div>
          </div>
          <div class="col-12 col-md-4">
            <select id="district" name="district" class="form-select">
              <option value="">Select District</option>
            </select>
            <div class="error-message" id="error-district"></div>
          </div>
          <div class="col-12 col-md-4">
            <input type="text" name="pincode" id="pincode" placeholder="Pincode" class="form-control" />
            <div class="error-message" id="error-pincode"></div>
          </div>
        </div>
      </div>

      <!-- Contact Info -->
      <div class="form-section">
        <label for="mobile" class="form-label">Mobile Number <span style="color:red">*</span></label>
        <input type="tel" id="mobile" name="mobile" class="form-control" maxlength="10" pattern="[0-9]*" inputmode="numeric" required />
        <div class="error-message" id="error-mobile"></div>
      </div>

      <div class="form-section">
        <label for="email" class="form-label">Email ID <span style="color:red">*</span></label>
        <input type="email" id="email" name="email" class="form-control" />
        <div class="error-message" id="error-email"></div>
      </div>

             <!-- Product Info -->
       <div class="form-section">
         <label for="productSelector" class="form-label">Select Product <span style="color:red">*</span></label>
         {% if available_products.count > 1 %}
           <select id="productSelector" name="product_id" class="form-select" required>
             <option value="">-- Select a Product --</option>
             {% for prod in available_products %}
               <option value="{{ prod.id }}">{{ prod.prdt_desc }}</option>
             {% endfor %}
           </select>
         {% else %}
           <input type="text" id="productName" name="product_name" class="form-control" value="{{ product.prdt_desc }}" readonly required />
           <input type="hidden" id="productSelector" value="{{ product.id }}" />
         {% endif %}
         <div class="error-message" id="error-productSelector"></div>
       </div>

       <div class="form-section">
         <label for="subProductSelector" class="form-label">Select Sub Product <span style="color:red">*</span></label>
         <select id="subProductSelector" class="form-select" required>
           <option value="">-- Select a Sub Product --</option>
           {% for p in products_with_rates %}
             {% for s in p.subs %}
               <option value="{{ s.sub.id }}" data-product-id="{{ p.product.id }}"
                       data-basic-amount="{{ s.rate_card.base_amt|default:'0' }}"
                       data-gst="{{ s.rate_card.gst_percent|default:'0' }}"
                       data-token-amount="{{ s.rate_card.token_amount|default:'0' }}"
                       data-installation-charges="{{ s.rate_card.installation_charge|default:'0' }}">
                 {{ p.product.prdt_desc }} — {{ s.sub.subprdt_desc }}
               </option>
             {% endfor %}
           {% endfor %}
         </select>
         <div class="error-message" id="error-subProductSelector"></div>
       </div>

       <!-- Rate Card Details (Hidden by default) -->
       <div class="form-section" id="rateCardDetails" style="display: none;">
         <h6 class="text-primary mb-3">Rate Card Details</h6>
         <div class="row">
           <div class="col-md-6">
             <div class="card bg-light rate-card-card">
               <div class="card-body">
                 <h6 class="card-title text-primary">Pricing Information</h6>
                 <p class="mb-1"><strong>Base Amount:</strong> ₹<span id="rateBaseAmount">-</span></p>
                 <p class="mb-1"><strong>GST:</strong> <span id="rateGst">-</span>%</p>
                 <p class="mb-1"><strong>Total with GST:</strong> ₹<span id="rateTotalGst">-</span></p>
               </div>
             </div>
           </div>
           <div class="col-md-6">
             <div class="card bg-light rate-card-card">
               <div class="card-body">
                 <h6 class="card-title text-success">Additional Charges</h6>
                 <p class="mb-1"><strong>Token Amount:</strong> ₹<span id="rateTokenAmount">-</span></p>
                 <p class="mb-1"><strong>Installation Charges:</strong> ₹<span id="rateInstallCharges">-</span></p>
                 <p class="mb-1"><strong>Final Total:</strong> ₹<span id="rateFinalTotal">-</span></p>
               </div>
             </div>
           </div>
         </div>
       </div>

      <div class="form-section">
        <label for="quantity" class="form-label">Quantity <span style="color:red">*</span></label>
        <input type="number" id="quantity" name="quantity" class="form-control" value="1" min="1" max="100" required />
        <div class="error-message" id="error-quantity"></div>
      </div>

      <!-- Token and Installation Charges Switches -->
      <div class="form-section" id="tokenSection" style="display:none;">
        <label>
          <input type="checkbox" id="add_token" checked>
          Add Token (<span id="tokenAmountLabel"></span>)
        </label>
      </div>
      <div class="form-section" id="installSection" style="display:none;">
        <label>
          <input type="checkbox" id="add_installation" checked>
          Add Installation Charges (<span id="installAmountLabel"></span>)
        </label>
      </div>
      <div class="form-section">
        <strong>Total: ₹<span id="totalAmount">0</span></strong>
      </div>

      <!-- Price Breakdown -->
      <div class="form-section bg-light rounded p-3" id="productDetailsContainer" style="display: none;">
        <h6 class="text-secondary">Price Breakdown</h6>
        <p>Basic Amount: <strong><span id="basicAmount">-</span></strong></p>
        <p>GST (<span id="gstRate">0</span>%): <strong><span id="gst">-</span></strong></p>
        <p>Total Price: <strong><span id="totalPrice">-</span></strong></p>
        <p id="tokenDetail" style="display: none;">Token Amount: <strong><span id="tokenAmountDetail">-</span></strong></p>
        <p id="installDetail" style="display: none;">Installation Charges: <strong><span id="installAmountDetail">-</span></strong></p>
        <p>Final Total: <strong><span id="finalTotal">-</span></strong></p>
      </div>

             <button type="button" id="generatePiBtn" class="btn btn-outline-primary w-100 mb-3">
         <span id="generateBtnText">Generate Proforma Invoice</span>
         <span id="generateBtnSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;" role="status" aria-hidden="true"></span>
       </button>
    </form>

  </div>
</div>

<!-- Proforma Invoice Modal -->
<div class="modal fade" id="piModal" tabindex="-1" aria-labelledby="piModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="piModalLabel">Proforma Invoice Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
              <div class="modal-body" id="piContent">
          <!-- Success message -->
          <div class="alert alert-success mb-3" id="successMessage" style="display: none;">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Success!</strong> Your form has been submitted successfully. Submission ID: <span id="quoteIdDisplay">-</span>
          </div>
          
          <!-- PI content inserted here dynamically -->
        </div>
      <div class="modal-footer">
        <button type="button" id="razorpayBtn" class="btn btn-primary">PAY-ONLINE</button>
        <button type="button" id="downloadPiBtn" class="btn btn-primary">Download PDF</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="piCloseBtn">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<!-- Rate Card Data -->
<script>
  const rateCardData = {
    {% for p in products_with_rates %}
      {% for s in p.subs %}
        {{ s.sub.id }}: {
          product_id: {{ p.product.id }},
          basic_amount: {{ s.rate_card.base_amt|default:0 }},
          gst_percent: {{ s.rate_card.gst_percent|default:0 }},
          token_amount: {{ s.rate_card.token_amount|default:0 }},
          installation_charge: {{ s.rate_card.installation_charge|default:0 }},
          product_name: "{{ p.product.prdt_desc }} — {{ s.sub.subprdt_desc }}"
        }{% if not forloop.last or not forloop.parentloop.last %},{% endif %}
      {% endfor %}
    {% endfor %}
  };
  
  // Debug: Log the rate card data
  console.log('Rate Card Data:', rateCardData);
  console.log('Products with rates count:', {{ products_with_rates|length }});
  console.log('Available products count:', {{ available_products.count }});
  
  // Log each product and its sub products
  {% for p in products_with_rates %}
    console.log('Product {{ p.product.id }}: {{ p.product.prdt_desc }}');
    {% for s in p.subs %}
      console.log('  Sub {{ s.sub.id }}: {{ s.sub.subprdt_desc }} - Rate: {{ s.rate_card.base_amt|default:0 }}');
    {% endfor %}
  {% endfor %}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Mobile number validation
  const mobileInput = document.getElementById('mobile');
  mobileInput.addEventListener('input', () => {
    mobileInput.value = mobileInput.value.replace(/\D/g, '').slice(0,10);
  });

  // GST selector logic
  const gstSelector = document.getElementById('gstSelector');
  const gstNumberField = document.getElementById('gstNumberField');
  const nonGstFields = document.getElementById('nonGstFields');

  gstSelector.addEventListener('change', function() {
    if (this.value === 'yes') {
      gstNumberField.style.display = 'block';
      nonGstFields.style.display = 'none';
      // Clear non-GST fields
      document.getElementById('address').value = '';
      document.getElementById('state').value = '';
      document.getElementById('district').value = '';
      document.getElementById('pincode').value = '';
    } else {
      gstNumberField.style.display = 'none';
      nonGstFields.style.display = 'block';
      // Clear GST field
      document.getElementById('gstNumber').value = '';
    }
  });

  // Product selector change handler – filter sub-products for this product
  const productSelector = document.getElementById('productSelector');
  const subProductSelector = document.getElementById('subProductSelector');
  if (productSelector.tagName === 'SELECT') {
    productSelector.addEventListener('change', function() {
      // filter sub products
      const pid = this.value;
      Array.from(subProductSelector.options).forEach((opt, idx) => {
        if (idx === 0) return; // keep placeholder
        opt.style.display = (!pid || opt.dataset.productId === pid) ? 'block' : 'none';
      });
      subProductSelector.value = '';
      hideRateCard();
      calculateTotal();
      // Update heading text to selected product
      const headingEl = document.getElementById('formHeading');
      if (headingEl && this.value) {
        const selectedOption = this.options[this.selectedIndex];
        const name = selectedOption ? selectedOption.text : 'Product';
        headingEl.textContent = `${name} Form`;
      } else if (headingEl) {
        headingEl.textContent = 'Product Form';
      }
    });
  }

  // Sub product change → update rate info
  subProductSelector.addEventListener('change', function() {
    updateProductInfoFromSub();
    calculateTotal();
  });

  // Quantity change handler
  const quantityInput = document.getElementById('quantity');
  quantityInput.addEventListener('change', calculateTotal);

  // Calculate total when page loads
  calculateTotal();
  
  // Update product info display
  updateProductInfo();

  // Generate PI button
  document.getElementById('generatePiBtn').addEventListener('click', generatePI);

  // Download PDF button
  document.getElementById('downloadPiBtn').addEventListener('click', downloadPDF);

  // Razorpay payment button
  document.getElementById('razorpayBtn').addEventListener('click', initiatePayment);

  // Redirect to home when PI modal is closed or Close button is clicked
  const piModalEl = document.getElementById('piModal');
  piModalEl.addEventListener('hidden.bs.modal', function () {
    window.location.href = '/';
  });
  const piCloseBtn = document.getElementById('piCloseBtn');
  if (piCloseBtn) {
    piCloseBtn.addEventListener('click', function() {
      const modalInstance = bootstrap.Modal.getInstance(piModalEl);
      if (modalInstance) modalInstance.hide();
      window.location.href = '/';
    });
  }
});

function updateProductInfo() {
  // This function updates the product info display when the page loads
  // It's called once to initialize the display
  const subSelect = document.getElementById('subProductSelector');
  if (subSelect.value) {
    updateProductInfoFromSub();
  }
}

function hideRateCard(){
  const rateCardDetails = document.getElementById('rateCardDetails');
  rateCardDetails.style.display = 'none';
}

function updateProductInfoFromSub() {
  const subSelect = document.getElementById('subProductSelector');
  const rateCardDetails = document.getElementById('rateCardDetails');
  if (!subSelect.value) { hideRateCard(); return; }
  
  console.log('Updating product info from sub product:', subSelect.value);
  
  // Get data from the selected option's data attributes
  const opt = subSelect.options[subSelect.selectedIndex];
  console.log('Selected option:', opt);
  console.log('Option dataset:', opt.dataset);
  
  const basicAmount = parseFloat(opt.dataset.basicAmount) || 0;
  const gstRate = parseFloat(opt.dataset.gst) || 0;
  const tokenAmount = parseFloat(opt.dataset.tokenAmount) || 0;
  const installCharges = parseFloat(opt.dataset.installationCharges) || 0;
  
  console.log('Parsed values:', { basicAmount, gstRate, tokenAmount, installCharges });
  
  // Update rate card display
  document.getElementById('rateBaseAmount').textContent = basicAmount.toFixed(2);
  document.getElementById('rateGst').textContent = gstRate.toFixed(2);
  const totalGst = basicAmount + (basicAmount * gstRate / 100);
  document.getElementById('rateTotalGst').textContent = totalGst.toFixed(2);
  document.getElementById('rateTokenAmount').textContent = tokenAmount.toFixed(2);
  document.getElementById('rateInstallCharges').textContent = installCharges.toFixed(2);
  const finalTotal = totalGst + tokenAmount + installCharges;
  document.getElementById('rateFinalTotal').textContent = finalTotal.toFixed(2);
  rateCardDetails.style.display = 'block';
}

function calculateTotal() {
  const quantity = parseInt(document.getElementById('quantity').value) || 1;
  console.log('Calculating total for quantity:', quantity);
  
  // Get pricing data from selected sub product
  let basicAmount, gstRate, tokenAmount, installCharges;
  const subSelect = document.getElementById('subProductSelector');
  console.log('Sub product selector value:', subSelect.value);
  console.log('Rate card data:', rateCardData);
  
  if (subSelect.value && rateCardData[subSelect.value]) {
    const rateData = rateCardData[subSelect.value];
    console.log('Rate data found:', rateData);
    basicAmount = parseFloat(rateData.basic_amount) || 0;
    gstRate = parseFloat(rateData.gst_percent) || 0;
    tokenAmount = parseFloat(rateData.token_amount) || 0;
    installCharges = parseFloat(rateData.installation_charge) || 0;
  } else { 
    console.log('No rate data found for sub product:', subSelect.value);
    basicAmount = gstRate = tokenAmount = installCharges = 0; 
  }

  const totalBasic = basicAmount * quantity;
  const gst = (totalBasic * gstRate) / 100;
  const totalWithGST = totalBasic + gst;
  const finalTotal = totalWithGST + tokenAmount + installCharges;

     // Update display
   document.getElementById('totalAmount').textContent = finalTotal.toFixed(2);
   document.getElementById('basicAmount').textContent = totalBasic.toFixed(2);
   document.getElementById('gstRate').textContent = gstRate.toFixed(2);
   document.getElementById('gst').textContent = gst.toFixed(2);
   document.getElementById('totalPrice').textContent = totalWithGST.toFixed(2);
   document.getElementById('finalTotal').textContent = finalTotal.toFixed(2);

  // Show/hide token and installation sections
  const tokenSection = document.getElementById('tokenSection');
  const installSection = document.getElementById('installSection');
  
  if (tokenAmount > 0) {
    tokenSection.style.display = 'block';
    document.getElementById('tokenAmountLabel').textContent = '₹' + tokenAmount.toFixed(2);
    document.getElementById('tokenDetail').style.display = 'block';
    document.getElementById('tokenAmountDetail').textContent = '₹' + tokenAmount.toFixed(2);
  } else {
    tokenSection.style.display = 'none';
    document.getElementById('tokenDetail').style.display = 'none';
  }

  if (installCharges > 0) {
    installSection.style.display = 'block';
    document.getElementById('installAmountLabel').textContent = '₹' + installCharges.toFixed(2);
    document.getElementById('installDetail').style.display = 'block';
    document.getElementById('installAmountDetail').textContent = '₹' + installCharges.toFixed(2);
  } else {
    installSection.style.display = 'none';
    document.getElementById('installDetail').style.display = 'none';
  }

  // Show price breakdown
  document.getElementById('productDetailsContainer').style.display = 'block';
}

async function generatePI() {
  console.log('Generate PI button clicked');
  
  // Validate form
  if (!validateForm()) {
    console.log('Form validation failed');
    return;
  }
  console.log('Form validation passed');

  // Show loading state
  const generateBtn = document.getElementById('generatePiBtn');
  const generateBtnText = document.getElementById('generateBtnText');
  const generateBtnSpinner = document.getElementById('generateBtnSpinner');
  
  generateBtn.disabled = true;
  generateBtnText.textContent = 'Saving...';
  generateBtnSpinner.style.display = 'inline-block';

  try {
    console.log('Attempting to save to database...');
    // Save to database first
    const saveResult = await saveToDatabase();
    console.log('Save result:', saveResult);
    
    if (!saveResult.success) {
      alert('Error saving submission: ' + saveResult.message);
      return;
    }

    // Show success message
    document.getElementById('successMessage').style.display = 'block';
    document.getElementById('quoteIdDisplay').textContent = saveResult.form_submission_id;

    // Generate PI content
    const piContent = generatePIContent();
    document.getElementById('piContent').innerHTML = piContent;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('piModal'));
    modal.show();
    
  } finally {
    // Reset button state
    generateBtn.disabled = false;
    generateBtnText.textContent = 'Generate Proforma Invoice';
    generateBtnSpinner.style.display = 'none';
  }
}

function validateForm() {
  let isValid = true;
  
  // Clear previous errors
  document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
  
  // Required fields validation
  const requiredFields = ['customerName', 'mobile', 'email'];
  requiredFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (!field.value.trim()) {
      document.getElementById(`error-${fieldId}`).textContent = 'This field is required';
      isValid = false;
    }
  });

  // Product selection validation
  const productSelector = document.getElementById('productSelector');
  if (productSelector.tagName === 'SELECT' && !productSelector.value) {
    document.getElementById('error-productSelector').textContent = 'Please select a product';
    isValid = false;
  }

  // Sub-product selection validation
  const subProductSelector = document.getElementById('subProductSelector');
  if (!subProductSelector.value) {
    document.getElementById('error-subProductSelector').textContent = 'Please select a sub product';
    isValid = false;
  }

  // GST validation
  const gstSelector = document.getElementById('gstSelector');
  if (gstSelector.value === 'yes') {
    const gstNumber = document.getElementById('gstNumber').value.trim();
    if (!gstNumber) {
      document.getElementById('error-gstNumber').textContent = 'GST number is required';
      isValid = false;
    }
  } else {
    const address = document.getElementById('address').value.trim();
    
    if (!address) {
      document.getElementById('error-address').textContent = 'Address is required';
      isValid = false;
    }
  }

  return isValid;
}

function generatePIContent() {
  console.log('Generating PI content...');
  
  const customerName = document.getElementById('customerName').value;
  const companyName = document.getElementById('companyName').value;
  const mobile = document.getElementById('mobile').value;
  const email = document.getElementById('email').value;
  const quantity = document.getElementById('quantity').value;
  
  console.log('Form data:', { customerName, companyName, mobile, email, quantity });
  
  // Get pricing data from selected product
  let basicAmount, gstRate, tokenAmount, installCharges, productName;
  
  const subSelect2 = document.getElementById('subProductSelector');
  console.log('Sub product selector value:', subSelect2.value);
  console.log('Rate card data available:', Object.keys(rateCardData));
  
  if (subSelect2.value && rateCardData[subSelect2.value]) {
    const rateData = rateCardData[subSelect2.value];
    console.log('PI - Rate data found:', rateData);
    basicAmount = parseFloat(rateData.basic_amount) || 0;
    gstRate = parseFloat(rateData.gst_percent || 0) || 0;
    tokenAmount = parseFloat(rateData.token_amount) || 0;
    installCharges = parseFloat(rateData.installation_charge) || 0;
    productName = rateData.product_name;
    console.log('PI - Parsed values:', { basicAmount, gstRate, tokenAmount, installCharges, productName });
  } else {
    console.log('PI - No rate data found, using defaults');
    basicAmount = gstRate = tokenAmount = installCharges = 0;
    productName = '{{ product.prdt_desc }}';
  }

  const includeToken = tokenAmount > 0 && document.getElementById('add_token')?.checked;
  const includeInstall = installCharges > 0 && document.getElementById('add_installation')?.checked;

  const totalBasic = parseFloat(basicAmount) * parseInt(quantity || 1, 10);
  const gst = (totalBasic * gstRate) / 100;
  const subTotal = totalBasic + gst;
  const finalTotal = subTotal + (includeToken ? tokenAmount : 0) + (includeInstall ? installCharges : 0);

  return `
    <div class="pi-header">
      <div class="pi-title">${productName} — Proforma Invoice</div>
      <div class="pi-sub">Generated on ${new Date().toLocaleString()}</div>
    </div>

    <div class="pi-summary">
      <div class="pi-card"><div class="label">Basic</div><div class="value">₹${totalBasic.toFixed(2)}</div></div>
      <div class="pi-card"><div class="label">GST (${gstRate}%)</div><div class="value">₹${gst.toFixed(2)}</div></div>
      <div class="pi-card"><div class="label">Subtotal</div><div class="value">₹${subTotal.toFixed(2)}</div></div>
    </div>

    <div class="pi-grid">
      <div>
        <table class="pi-table">
          <tbody>
            <tr><th>Customer</th><td>${customerName}</td></tr>
            <tr><th>Company</th><td>${companyName || 'N/A'}</td></tr>
            <tr><th>Mobile</th><td>${mobile}</td></tr>
            <tr><th>Email</th><td>${email}</td></tr>
          </tbody>
        </table>
      </div>
      <div>
        <table class="pi-table">
          <tbody>
                         <tr><th>Product</th><td>${productName}</td></tr>
            <tr><th>Quantity</th><td>${quantity}</td></tr>
            ${includeToken ? `<tr><th>Token Amount</th><td>₹${tokenAmount.toFixed(2)}</td></tr>` : ''}
            ${includeInstall ? `<tr><th>Installation</th><td>₹${installCharges.toFixed(2)}</td></tr>` : ''}
            <tr class="pi-total-row"><th>Total</th><td>₹${finalTotal.toFixed(2)}</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function downloadPDF() {
  console.log('Download PDF button clicked');
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const M = 24; // tighter margin for fuller look
  const contentW = pageWidth - 2 * M;

  // Helpers
  const fmt = (n) => {
    const num = Number(n || 0);
    return num.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  };

  // Collect form/customer
  const customer = {
    name: document.getElementById('customerName').value,
    company: document.getElementById('companyName').value || 'N/A',
    mobile: document.getElementById('mobile').value,
    email: document.getElementById('email').value,
  };

  // Pricing source - Get data from selected sub product
  const subProductSelector = document.getElementById('subProductSelector');
  let unitPrice, gstRate, tokenAmount, installCharges, productName;
  const quantity = parseInt(document.getElementById('quantity').value) || 1;

  if (subProductSelector.value && rateCardData[subProductSelector.value]) {
    const rateData = rateCardData[subProductSelector.value];
    console.log('PDF - Rate data from sub product:', rateData);
    unitPrice = parseFloat(rateData.basic_amount) || 0;
    gstRate = parseFloat(rateData.gst_percent) || 0;
    tokenAmount = parseFloat(rateData.token_amount) || 0;
    installCharges = parseFloat(rateData.installation_charge) || 0;
    productName = rateData.product_name;
    console.log('PDF - Parsed values:', { unitPrice, gstRate, tokenAmount, installCharges, productName });
  } else {
    // Fallback to product selector if sub product not selected
    const productSelector = document.getElementById('productSelector');
    if (productSelector.tagName === 'SELECT' && productSelector.value) {
      const opt = productSelector.options[productSelector.selectedIndex];
      unitPrice = parseFloat(opt.dataset.basicAmount) || 0;
      gstRate = parseFloat(opt.dataset.gst || 0) || 0;
      tokenAmount = parseFloat(opt.dataset.tokenAmount) || 0;
      installCharges = parseFloat(opt.dataset.installationCharges) || 0;
      productName = opt.text;
    } else {
      unitPrice = gstRate = tokenAmount = installCharges = 0;
      productName = '{{ product.prdt_desc }}';
    }
  }

  const includeToken = tokenAmount > 0 && document.getElementById('add_token')?.checked;
  const includeInstall = installCharges > 0 && document.getElementById('add_installation')?.checked;

  const lineBasic = unitPrice * quantity;
  const lineGst = (lineBasic * gstRate) / 100;
  const lineTotal = lineBasic + lineGst;

  const basicTotal = lineBasic;
  const gstTotal = lineGst;
  const subTotal = basicTotal + gstTotal;
  const grandTotal = subTotal + (includeToken ? tokenAmount : 0) + (includeInstall ? installCharges : 0);

  const invoiceNo = 'PI-' + new Date().getTime();
  const invoiceDate = new Date().toLocaleDateString();

  // Header band
  doc.setFillColor(23, 63, 132);
  doc.rect(0, 0, pageWidth, 70, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(16);
  doc.text('PROFORMA INVOICE', M, 42);
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text(`Invoice No: ${invoiceNo}`, pageWidth - M, 26, { align: 'right' });
  doc.text(`Date: ${invoiceDate}`, pageWidth - M, 42, { align: 'right' });

  // Subheader product line
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(12);
  doc.text(String(productName || 'Product'), M, 26);

  let y = 90;

  // Buyer/Seller blocks
  doc.setFont('helvetica', 'bold');
  doc.setTextColor('#374151');
  doc.text('Seller', M, y);
  doc.text('Buyer', pageWidth / 2, y);
  doc.setFont('helvetica', 'normal');
  y += 18;
  const seller = ['FusionTec Software', 'www.fusiontec.com', 'info@fusiontec.com'];
  const buyer = [customer.name, customer.company, `${customer.mobile} • ${customer.email}`];
  seller.forEach((s, i) => doc.text(s, M, y + i * 14));
  buyer.forEach((b, i) => doc.text(b, pageWidth / 2, y + i * 14));

  // Items table
  const tableY = y + 48;
  const body = [
    [productName, String(quantity), fmt(unitPrice), `${gstRate}%`, fmt(lineGst), fmt(lineTotal)],
  ];
  if (includeToken) body.push(['Token Charges', '1', fmt(tokenAmount), '-', '-', fmt(tokenAmount)]);
  if (includeInstall) body.push(['Installation', '1', fmt(installCharges), '-', '-', fmt(installCharges)]);

  // proportional column widths to fill page
  const wDesc = Math.round(contentW * 0.40);
  const wQty  = Math.round(contentW * 0.08);
  const wUnit = Math.round(contentW * 0.16);
  const wPct  = Math.round(contentW * 0.08);
  const wGst  = Math.round(contentW * 0.12);
  const wLine = Math.round(contentW * 0.16);

  doc.autoTable({
    startY: tableY,
    head: [['Description', 'Qty', 'Unit Price', 'GST %', 'GST Amt', 'Line Total']],
    body,
    theme: 'grid',
    styles: { font: 'helvetica', fontStyle: 'normal', fontSize: 10, cellPadding: 6 },
    headStyles: { fillColor: [23, 63, 132], textColor: 255 },
    margin: { left: M, right: M },
    tableWidth: contentW,
    columnStyles: {
      0: { cellWidth: wDesc },
      1: { cellWidth: wQty, halign: 'right' },
      2: { cellWidth: wUnit, halign: 'right' },
      3: { cellWidth: wPct, halign: 'right' },
      4: { cellWidth: wGst, halign: 'right' },
      5: { cellWidth: wLine, halign: 'right' },
    },
    didDrawPage: (data) => {
      // repeat header/footer
      doc.setFillColor(23, 63, 132);
      doc.rect(0, 0, pageWidth, 70, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(16);
      doc.text('PROFORMA INVOICE', M, 42);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.text(`Invoice No: ${invoiceNo}`, pageWidth - M, 26, { align: 'right' });
      doc.text(`Date: ${invoiceDate}`, pageWidth - M, 42, { align: 'right' });
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text(String(productName || 'Product'), M, 26);
    },
  });

  y = doc.lastAutoTable.finalY + 16;

  // If close to bottom, add page
  if (y > pageHeight - 180) {
    doc.addPage();
    y = 90;
  }

  // Totals panel (right-aligned table)
  const totals = [
    ['Basic Total', fmt(basicTotal)],
    [`GST (${gstRate}%)`, fmt(gstTotal)],
    ['Subtotal', fmt(subTotal)],
  ];
  if (includeToken) totals.push(['Token Amount', fmt(tokenAmount)]);
  if (includeInstall) totals.push(['Installation', fmt(installCharges)]);
  totals.push([{ content: 'Grand Total', styles: { fontStyle: 'bold' } }, { content: `INR ${fmt(grandTotal)}`, styles: { fontStyle: 'bold' } }]);

  doc.autoTable({
    startY: y,
    head: [['', '']],
    body: totals,
    theme: 'plain',
    styles: { font: 'helvetica', fontSize: 11, cellPadding: 4 },
    columnStyles: { 0: { halign: 'right' }, 1: { halign: 'right' } },
    margin: { left: pageWidth - M - 300 },
    tableWidth: 300,
  });

  // Footer/notes
  const fY = doc.lastAutoTable.finalY + 24;
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(9);
  doc.setTextColor('#6b7280');
  doc.text('Terms: Payment due within 7 days. This PI is valid for 15 days from the issue date.', M, fY);

  const safe = (productName || 'product').toLowerCase().replace(/\s+/g, '_');
  doc.save(safe + '_PI.pdf');
}

async function saveToDatabase() {
  try {
    console.log('Collecting form data...');
    
    // Get form data
    const formData = {
      customer_name: document.getElementById('customerName').value.trim(),
      company_name: document.getElementById('companyName').value.trim(),
      mobile: document.getElementById('mobile').value.trim(),
      email: document.getElementById('email').value.trim(),
      has_gst: document.getElementById('gstSelector').value,
      gst_number: document.getElementById('gstNumber').value.trim(),
      address: document.getElementById('address').value.trim(),
      state: document.getElementById('state').value,
      district: document.getElementById('district').value,
      pincode: document.getElementById('pincode').value.trim(),
      product_id: document.getElementById('productSelector').value,
      sub_product_id: document.getElementById('subProductSelector').value,
      quantity: parseInt(document.getElementById('quantity').value) || 1,
      basic_amount: parseFloat(document.getElementById('basicAmount').textContent) || 0,
      gst: parseFloat(document.getElementById('gst').textContent) || 0,
      total_amount: parseFloat(document.getElementById('totalPrice').textContent) || 0,
      token_amount: parseFloat(document.getElementById('tokenAmountDetail')?.textContent?.replace('₹', '') || '0') || 0,
      installing_charges: parseFloat(document.getElementById('installAmountDetail')?.textContent?.replace('₹', '') || '0') || 0,
      grand_total: parseFloat(document.getElementById('finalTotal').textContent) || 0
    };
    
    console.log('Form data collected:', formData);

    // Send to server
    console.log('Sending request to /save-product-submission/');
    const response = await fetch('/save-product-submission/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify(formData)
    });

    console.log('Response status:', response.status);
    const result = await response.json();
    console.log('Response data:', result);
    
    if (result.status === 'success') {
      return { success: true, form_submission_id: result.form_submission_id };
    } else {
      return { success: false, message: result.message };
    }
    
  } catch (error) {
    console.error('Error saving to database:', error);
    return { success: false, message: 'Network error occurred' };
  }
}

async function initiatePayment() {
  try {
    // Build context
    const customerName = document.getElementById('customerName').value.trim();
    const email = document.getElementById('email').value.trim();
    const mobile = document.getElementById('mobile').value.trim();
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    const subId = document.getElementById('subProductSelector').value;

    if (!customerName || !email || !mobile || !subId) {
      alert('Please fill customer details and select a sub product before paying.');
      return;
    }

    // Determine amount and product name from selected sub product
    let unit = 0, gstRate = 0, tokenAmt = 0, installAmt = 0, productName = 'Product';
    if (subId && rateCardData[subId]) {
      const r = rateCardData[subId];
      unit = parseFloat(r.basic_amount) || 0;
      gstRate = parseFloat(r.gst_percent) || 0;
      tokenAmt = parseFloat(r.token_amount) || 0;
      installAmt = parseFloat(r.installation_charge) || 0;
      productName = r.product_name;
    }
    const lineBasic = unit * quantity;
    const lineGst = (lineBasic * gstRate) / 100;
    const totalWithGst = lineBasic + lineGst;
    const includeToken = tokenAmt > 0 && document.getElementById('add_token')?.checked;
    const includeInstall = installAmt > 0 && document.getElementById('add_installation')?.checked;
    const grandTotal = totalWithGst + (includeToken ? tokenAmt : 0) + (includeInstall ? installAmt : 0);

    const formSubmissionId = document.getElementById('quoteIdDisplay')?.textContent?.trim() || null;

    // Create order via backend
    const resp = await fetch('/api/payments/create-order/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
      body: JSON.stringify({
        amount: grandTotal,
        customer_name: customerName,
        email,
        mobile,
        product_name: productName,
        form_submission_id: formSubmissionId,
      })
    });
    const data = await resp.json();
    if (data.status !== 'success') {
      alert('Failed to create payment order: ' + (data.message || 'Unknown error'));
      return;
    }

    const options = {
      key: data.key,
      amount: data.amount,
      currency: data.currency || 'INR',
      name: 'FusionTec Software',
      description: productName,
      order_id: data.order_id,
      prefill: { name: customerName, email, contact: mobile },
      notes: { form_submission_id: formSubmissionId || '' },
      handler: async function (response) {
        try {
          const verifyResp = await fetch('/api/payments/verify/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
            body: JSON.stringify({
              ...response,
              amount: grandTotal,
              customer_name: customerName,
              email,
              mobile,
              form_submission_id: formSubmissionId,
            })
          });
          const verifyData = await verifyResp.json();
          if (verifyData.status === 'success') {
            alert('Payment successful! Thank you.');
            window.location.href = '/';
          } else {
            alert('Payment verification failed: ' + (verifyData.message || 'Unknown error'));
          }
        } catch (err) {
          console.error('Verification error', err);
          alert('Error verifying payment.');
        }
      },
      theme: { color: '#0d6efd' }
    };

    const rzp = new Razorpay(options);
    rzp.open();
  } catch (e) {
    console.error('initiatePayment error', e);
    alert('Could not initiate payment.');
  }
}

// API for dynamic dropdown
document.addEventListener("DOMContentLoaded", () => {
  const stateSelect = document.getElementById("state");
  const districtSelect = document.getElementById("district");

  if (!stateSelect || !districtSelect) {
    console.error("State or district dropdown not found in the DOM");
    return;
  }

  // Load states
  fetch("/api/states/")
    .then(res => res.json())
    .then(data => {
      if (!data.states || !Array.isArray(data.states)) {
        throw new Error("Invalid states data format");
      }
      stateSelect.innerHTML = `<option value="">Select State</option>` +
        data.states.map(s => `<option value="${s}">${s}</option>`).join('');
    })
    .catch(err => {
      console.error("Error loading states:", err);
      alert("Failed to load states. Please try again later.");
    });

  // On state change: load districts
  stateSelect.addEventListener("change", () => {
    const state = stateSelect.value;
    if (!state) return;

    districtSelect.innerHTML = `<option>Loading...</option>`;

    fetch(`/api/districts/${encodeURIComponent(state)}/`)
      .then(res => res.json())
      .then(data => {
        if (!data.districts || !Array.isArray(data.districts)) {
          throw new Error("Invalid districts data format");
        }
        districtSelect.innerHTML = `<option value="">Select District</option>` +
          data.districts.map(d => `<option value="${d}">${d}</option>`).join('');
      })
      .catch(err => {
        console.error("Error loading districts:", err);
        districtSelect.innerHTML = `<option value="">Failed to load districts</option>`;
        alert("Failed to load districts. Please try again.");
      });
  });
});
</script>

{% endblock %}
